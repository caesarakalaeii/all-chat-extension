(()=>{"use strict";const e={apiGatewayUrl:"https://allch.at",preferences:{autoDetectEnabled:!0,replaceNativeChat:!0,fontSize:"medium"}};async function t(e){return new Promise(t=>{chrome.storage.sync.set(e,()=>t())})}async function a(e){return new Promise(t=>{chrome.storage.local.set(e,()=>t())})}async function o(){const t=await async function(){return new Promise(t=>{chrome.storage.sync.get(e,e=>{t(e)})})}();return console.log("[AllChat Storage] API Gateway URL:",t.apiGatewayUrl),t.apiGatewayUrl}async function n(){return(await async function(){return new Promise(e=>{chrome.storage.local.get(null,t=>{e(t)})})}()).viewer_jwt_token||null}async function r(){return new Promise(e=>{chrome.storage.local.remove(["viewer_jwt_token","viewer_info"],()=>e())})}let c=null,s=null,i=0,l=null,u=null,h="disconnected";async function w(e){if(c&&c.readyState===WebSocket.OPEN&&s===e)return void console.log("[AllChat] Already connected to overlay:",e);c&&c.close();const t=`${(await o()).replace(/^http/,"ws")}/ws/overlay/${e}`;console.log("[AllChat] Connecting to WebSocket:",t),m(i>0?"reconnecting":"connecting"),c=new WebSocket(t),s=e,c.onopen=()=>{console.log("[AllChat] WebSocket connected"),i=0,l=setInterval(()=>{c&&c.readyState===WebSocket.OPEN&&c.send(JSON.stringify({type:"ping",timestamp:(new Date).toISOString()}))},3e4),chrome.action.setBadgeBackgroundColor({color:"#00ff00"}),chrome.action.setBadgeText({text:"✓"}),m("connected")},c.onmessage=e=>{try{t=JSON.parse(e.data),console.log("[AllChat] WebSocket message:",t.type),chrome.tabs.query({},e=>{e.forEach(e=>{e.id&&chrome.tabs.sendMessage(e.id,{type:"WS_MESSAGE",data:t}).catch(()=>{})})})}catch(e){console.error("[AllChat] Failed to parse WebSocket message:",e)}var t},c.onerror=e=>{console.error("[AllChat] WebSocket error:",e),chrome.action.setBadgeBackgroundColor({color:"#ff0000"}),chrome.action.setBadgeText({text:"✗"})},c.onclose=()=>{if(console.log("[AllChat] WebSocket closed"),d(),chrome.action.setBadgeBackgroundColor({color:"#888888"}),chrome.action.setBadgeText({text:""}),u&&(clearTimeout(u),u=null),i<10){i++;const e=1e3*i;console.log(`[AllChat] Reconnecting in ${e}ms (attempt ${i}/10)`),m("reconnecting",{reconnectIn:e}),u=setTimeout(()=>{s&&w(s)},e)}else console.error("[AllChat] Max reconnection attempts reached"),chrome.action.setBadgeBackgroundColor({color:"#ff0000"}),chrome.action.setBadgeText({text:"✗"}),m("failed")}}function d(){l&&(clearInterval(l),l=null)}function m(e,t){h=e,chrome.tabs.query({},a=>{a.forEach(a=>{a.id&&chrome.tabs.sendMessage(a.id,{type:"CONNECTION_STATE",data:{state:e,attempts:i,maxAttempts:10,...t}}).catch(()=>{})})})}async function f(e){const t=await o(),a=await fetch(`${t}/api/v1/auth/viewer/me`,{headers:{Authorization:`Bearer ${e}`}});if(!a.ok)throw new Error("Failed to fetch viewer info");return a.json()}chrome.runtime.onInstalled.addListener(a=>{"install"===a.reason?(console.log("[AllChat] Extension installed"),t(e)):"update"===a.reason&&(console.log("[AllChat] Extension updated to",chrome.runtime.getManifest().version),t({apiGatewayUrl:e.apiGatewayUrl}))}),chrome.runtime.onMessage.addListener((e,t,l)=>((async()=>{try{switch(e.type){case"GET_STREAMER_INFO":const t=await async function(e){const t=`${await o()}/api/v1/auth/streamers/${encodeURIComponent(e)}`;console.log("[AllChat] Fetching streamer info from:",t);const a=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}});if(404===a.status)throw new Error("STREAMER_NOT_FOUND");if(!a.ok)throw new Error("FETCH_FAILED");return a.json()}(e.username);l({success:!0,data:t});break;case"CONNECT_WEBSOCKET":await w(e.overlayId),l({success:!0});break;case"DISCONNECT_WEBSOCKET":c&&(c.close(),c=null,s=null),d(),u&&(clearTimeout(u),u=null),i=0,m("disconnected"),l({success:!0});break;case"SEND_CHAT_MESSAGE":await async function(e,t){const a=await async function(){const e=await n();if(!e)return null;try{const t=1e3*JSON.parse(atob(e.split(".")[1])).exp;return Date.now()>=t?(console.log("[AllChat] Token expired, clearing"),await r(),null):e}catch(e){return console.error("[AllChat] Failed to decode token:",e),await r(),null}}();if(!a)throw new Error("NOT_AUTHENTICATED");const c=await o(),s=await fetch(`${c}/api/v1/auth/viewer/chat/send`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({streamer_username:e,message:t})});if(429===s.status)throw{error:"RATE_LIMITED",data:{reset_time:(await s.json()).reset_time}};if(!s.ok){const e=await s.json();throw new Error(e.error||"SEND_FAILED")}}(e.streamerUsername,e.message),l({success:!0});break;case"START_AUTH":const h=await async function(e,t){const a=await o();let n;if("twitch"===e)n="/api/v1/auth/viewer/twitch/login";else{if("youtube"!==e)throw new Error("Unsupported platform");n="/api/v1/auth/viewer/youtube/login"}const r=new URL(`${a}${n}`);t&&r.searchParams.set("streamer",t);const c=await fetch(r.toString());return(await c.json()).auth_url}(e.platform,e.streamerUsername);l({success:!0,data:{authUrl:h}});break;case"GET_AUTH_STATUS":const g=await n(),y=g?await f(g):null;l({success:!0,data:{authenticated:!!g,viewerInfo:y}});break;case"LOGOUT":await r(),l({success:!0});break;case"STORE_VIEWER_TOKEN":await async function(e){await a({viewer_jwt_token:e});try{const t=await f(e);await a({viewer_info:t})}catch(e){console.error("[AllChat] Failed to fetch viewer info:",e)}}(e.token),l({success:!0});break;default:l({success:!1,error:"Unknown message type"})}}catch(e){console.error("[AllChat] Service worker error:",e),l({success:!1,error:e.message})}})(),!0)),console.log("[AllChat] Service worker initialized")})();