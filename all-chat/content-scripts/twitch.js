(()=>{"use strict";class t{async init(){console.log(`[AllChat ${this.platform}] Initializing...`);const t=this.extractStreamerUsername();if(t){console.log(`[AllChat ${this.platform}] Detected streamer: ${t}`);try{const e=await this.checkStreamerExists(t);if(!e)return console.log(`[AllChat ${this.platform}] Streamer not in database, showing native chat`),void this.showNotConfiguredBadge(t);console.log(`[AllChat ${this.platform}] Streamer found! Overlay ID: ${e.overlay_id}`),this.hideNativeChat();const n=this.createInjectionPoint();if(!n)return void console.error(`[AllChat ${this.platform}] Failed to create injection point`);this.injectAllChatUI(n,e.overlay_id,t),await this.connectWebSocket(e.overlay_id)}catch(t){console.error(`[AllChat ${this.platform}] Initialization failed:`,t)}}else console.log(`[AllChat ${this.platform}] Could not extract streamer username`)}async checkStreamerExists(t){try{const e=await chrome.runtime.sendMessage({type:"GET_STREAMER_INFO",username:t});if(!e.success){if("STREAMER_NOT_FOUND"===e.error)return null;throw new Error(e.error)}return e.data}catch(t){return console.error(`[AllChat ${this.platform}] API check failed:`,t),null}}injectAllChatUI(t,e,n){const o=document.createElement("iframe");o.id="allchat-iframe",o.src=chrome.runtime.getURL("ui/chat-container.html"),o.style.cssText="width: 100%; height: 100%; border: none; background: transparent;",o.setAttribute("data-overlay-id",e),o.setAttribute("data-streamer",n),o.setAttribute("data-platform",this.platform),t.appendChild(o),o.addEventListener("load",()=>{o.contentWindow?.postMessage({type:"ALLCHAT_INIT",overlayId:e,platform:this.platform,streamer:n},"*")}),console.log(`[AllChat ${this.platform}] UI injected`)}async connectWebSocket(t){const e=await chrome.runtime.sendMessage({type:"CONNECT_WEBSOCKET",overlayId:t});e.success||console.error(`[AllChat ${this.platform}] WebSocket connection failed:`,e.error)}showNotConfiguredBadge(t){const e=document.createElement("div");e.id="allchat-not-configured-badge",e.style.cssText="\n      position: fixed;\n      bottom: 10px;\n      right: 10px;\n      padding: 8px 12px;\n      background: #1f1f23;\n      border: 1px solid #3a3a3d;\n      border-radius: 4px;\n      color: #adadb8;\n      font-size: 12px;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      z-index: 9999;\n      opacity: 0.8;\n      cursor: pointer;\n    ",e.textContent=`${t} is not using All-Chat`,e.title="This streamer has not set up All-Chat yet",setTimeout(()=>e.remove(),1e4),e.addEventListener("click",()=>e.remove()),document.body.appendChild(e)}findChatContainer(){const t=this.getChatContainerSelector();for(const e of t){const t=document.querySelector(e);if(t)return console.log(`[AllChat ${this.platform}] Found chat container with selector: ${e}`),t}return console.warn(`[AllChat ${this.platform}] Could not find chat container`),null}}class e extends t{constructor(){super(...arguments),this.platform="twitch"}extractStreamerUsername(){const t=window.location.pathname.match(/^\/([^\/]+)/);if(!t)return null;const e=t[1];return["directory","downloads","jobs","turbo","settings","subscriptions","inventory","wallet","drops"].includes(e.toLowerCase())?null:e}getChatContainerSelector(){return['[data-test-selector="chat-scrollable-area"]','div[role="log"]',".chat-scrollable-area__message-container",".chat-shell",".right-column",'[data-a-target="right-column-chat-bar"]']}hideNativeChat(){const t=this.findChatContainer();if(t){const e=t.closest(".right-column")||t.parentElement;e&&(e.style.display="none",e.setAttribute("data-allchat-hidden","true"))}}createInjectionPoint(){const t=this.findChatContainer();if(!t)return null;const e=t.closest(".right-column")?.parentElement||t.parentElement;if(!e)return null;const n=document.createElement("div");return n.id="allchat-container",n.className="right-column",n.style.cssText="\n      width: 340px;\n      height: 100%;\n      background-color: #18181b;\n      display: flex;\n      flex-direction: column;\n    ",e.appendChild(n),n}}!function(){console.log("[AllChat Twitch] Content script loaded");const t=new e;"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>t.init(),1e3)}):setTimeout(()=>t.init(),1e3),function(t){let e=null;new MutationObserver(()=>{const n=document.getElementById("allchat-container"),o=document.querySelector(".chat-scrollable-area__message-container");!n&&o&&(console.log("[AllChat Twitch] Detected re-render, re-injecting..."),e&&clearTimeout(e),e=setTimeout(()=>{t.init()},500))}).observe(document.body,{childList:!0,subtree:!0})}(t),function(t){let e=location.href;new MutationObserver(()=>{const n=location.href;n!==e&&(e=n,console.log("[AllChat Twitch] URL changed, re-initializing..."),setTimeout(()=>t.init(),1e3))}).observe(document,{subtree:!0,childList:!0})}(t)}()})();